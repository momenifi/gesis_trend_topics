<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Hierarchical Topics (LLM)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #fafafa;
    }
    #chart {
      border: 1px solid #e5e7eb;
      background: #ffffff;
      max-height: 90vh;
      overflow: auto;
    }
    .node circle {
      fill: #4c78a8;
      stroke: #2b4c6f;
      stroke-width: 1px;
    }
    .node text {
      font-size: 12px;
      fill: #1f2933;
    }
    .node .toggle {
      font-size: 12px;
      fill: #fff;
      pointer-events: none;
    }
    .link {
      fill: none;
      stroke: #9fb3c8;
      stroke-width: 1.2px;
    }
  </style>
</head>
<body>
<h2>Hierarchical Topics (LLM Labels)</h2>
<div id="chart"></div>
<script>
const treeData = {"id": "P56", "name": "panel_web_media_germany_attitudes (n=823)", "lines": 2, "tooltip": "", "children": [{"id": "P53", "name": "mixed mode_probability based_internet_questionnaire_waves (n=164)", "lines": 3, "tooltip": "", "children": [{"id": "P34", "name": "probability based_internet_face_waves_mixed mode panel (n=94)", "lines": 3, "tooltip": "", "children": [{"id": "P29", "name": "probability based_recruitment_mixed mode_online panel_machine learning (n=63)", "lines": 4, "tooltip": "", "children": [{"id": "T6", "name": "nonresponse, waves, machine learning, mixed mode panel, population (T6), n=32", "lines": 4, "tooltip": ""}, {"id": "T8", "name": "recruitment, online panel, probability based, mixed mode, access (T8), n=31", "lines": 4, "tooltip": ""}]}, {"id": "T7", "name": "face, sampling, mixed mode, costs, web (T7), n=31", "lines": 3, "tooltip": ""}]}, {"id": "P44", "name": "web_questionnaire_comparability_closed_split (n=70)", "lines": 2, "tooltip": "", "children": [{"id": "P41", "name": "web_closed_comparability_reduction_questionnaire (n=44)", "lines": 2, "tooltip": "", "children": [{"id": "T11", "name": "comparability, big, governance, personality traits, level (T11), n=23", "lines": 3, "tooltip": ""}, {"id": "T15", "name": "closed, quality, pretesting, coding, interviewing (T15), n=21", "lines": 3, "tooltip": ""}]}, {"id": "P38", "name": "version_machine_questionnaire_text_comparability (n=26)", "lines": 2, "tooltip": "", "children": [{"id": "T28", "name": "interviewing, performance, pretesting, machine learning, prevalence (T28), n=10", "lines": 4, "tooltip": ""}, {"id": "T17", "name": "split, questionnaire, errors, machine, languages (T17), n=16", "lines": 3, "tooltip": ""}]}]}]}, {"id": "P55", "name": "political_gender_germany_differences_social media (n=659)", "lines": 2, "tooltip": "", "children": [{"id": "P54", "name": "political_germany_differences_social media_search (n=609)", "lines": 2, "tooltip": "", "children": [{"id": "P50", "name": "large_machine learning_language models_social media_llms (n=142)", "lines": 4, "tooltip": "", "children": [{"id": "P47", "name": "fit_networks_real world_correlation_images (n=25)", "lines": 3, "tooltip": "", "children": [{"id": "T27", "name": "family, network, italy, united states, correlation (T27), n=11", "lines": 3, "tooltip": ""}, {"id": "T21", "name": "modeling, detection, correlation, gender, depth (T21), n=14", "lines": 3, "tooltip": ""}]}, {"id": "P45", "name": "machine learning_llms_large language models_social media_authors (n=117)", "lines": 4, "tooltip": "", "children": [{"id": "T14", "name": "arguments, quality, mining, language model, artificial intelligence (T14), n=21", "lines": 4, "tooltip": ""}, {"id": "P39", "name": "machine learning_language models_social media_large_open science (n=96)", "lines": 4, "tooltip": "", "children": [{"id": "P33", "name": "machine learning_web_coding_large language models_llms (n=81)", "lines": 4, "tooltip": "", "children": [{"id": "T1", "name": "machine learning, large language models, llms, mining, errors (T1), n=50", "lines": 3, "tooltip": ""}, {"id": "T9", "name": "government, metadata, channels, recognition, energy (T9), n=31", "lines": 3, "tooltip": ""}]}, {"id": "T20", "name": "open science, social media, publications, training, retrieval (T20), n=15", "lines": 4, "tooltip": ""}]}]}]}, {"id": "P52", "name": "germany_differences_identity_election_social media (n=467)", "lines": 2, "tooltip": "", "children": [{"id": "P48", "name": "germany_attitudes_inequality_migration_vote (n=297)", "lines": 2, "tooltip": "", "children": [{"id": "P46", "name": "differences_germany_personality_migration_elections (n=261)", "lines": 2, "tooltip": "", "children": [{"id": "P37", "name": "germany_differences_personality_migration_election (n=240)", "lines": 2, "tooltip": "", "children": [{"id": "T16", "name": "public opinion, driven, psychology, privacy, cross (T16), n=19", "lines": 3, "tooltip": ""}, {"id": "P32", "name": "germany_attitudes_migration_age_election (n=221)", "lines": 2, "tooltip": "", "children": [{"id": "T3", "name": "political, multilevel, perception, germany, trust (T3), n=40", "lines": 3, "tooltip": ""}, {"id": "T0", "name": "germany, migration, differences, personality, election (T0), n=181", "lines": 3, "tooltip": ""}]}]}, {"id": "T13", "name": "gender, organizations, europe, inclusion, measurement (T13), n=21", "lines": 3, "tooltip": ""}]}, {"id": "P42", "name": "digital_frameworks_social science_german_measurement invariance (n=36)", "lines": 3, "tooltip": "", "children": [{"id": "T12", "name": "digital, frameworks, social science, measurement invariance, error (T12), n=21", "lines": 4, "tooltip": ""}, {"id": "T19", "name": "chapter, processes, germany, changes, political attitudes (T19), n=15", "lines": 4, "tooltip": ""}]}]}, {"id": "P51", "name": "social media_polarization_detection_election_trust (n=170)", "lines": 3, "tooltip": "", "children": [{"id": "P40", "name": "facebook_political_reliability_tracking_search engines (n=72)", "lines": 2, "tooltip": "", "children": [{"id": "T24", "name": "search engines, performance, open science, political science, 2021 (T24), n=13", "lines": 4, "tooltip": ""}, {"id": "P36", "name": "facebook_reliability_web browsing_political_tracking (n=59)", "lines": 3, "tooltip": "", "children": [{"id": "T2", "name": "facebook, reliability, web browsing, tracking, life (T2), n=43", "lines": 3, "tooltip": ""}, {"id": "T18", "name": "content, political attitudes, web tracking, measure, tweets (T18), n=16", "lines": 4, "tooltip": ""}]}]}, {"id": "P49", "name": "privacy_polarization_political_social media_misinformation (n=98)", "lines": 3, "tooltip": "", "children": [{"id": "P43", "name": "polarization_social media_campaigning_misinformation_security (n=84)", "lines": 3, "tooltip": "", "children": [{"id": "T26", "name": "discourse, social media, polarization, scenarios, election (T26), n=12", "lines": 3, "tooltip": ""}, {"id": "P31", "name": "privacy_polarization_journalism_misinformation_candidate (n=72)", "lines": 2, "tooltip": "", "children": [{"id": "T4", "name": "polarization, security, misinformation, social media, election (T4), n=37", "lines": 4, "tooltip": ""}, {"id": "T5", "name": "trust, learning, journalism, measurement, groups (T5), n=35", "lines": 3, "tooltip": ""}]}]}, {"id": "T22", "name": "voting, immigration, media, right wing, individual level (T22), n=14", "lines": 4, "tooltip": ""}]}]}]}]}, {"id": "P35", "name": "covid 19 pandemic_beliefs_risk_european_children (n=50)", "lines": 3, "tooltip": "", "children": [{"id": "T23", "name": "european, governance, crises, attitudes, levels (T23), n=13", "lines": 3, "tooltip": ""}, {"id": "P30", "name": "19 pandemic_beliefs_risk_students_share (n=37)", "lines": 3, "tooltip": "", "children": [{"id": "T25", "name": "risk, children, immigration, 19 pandemic, 2020 (T25), n=13", "lines": 3, "tooltip": ""}, {"id": "T10", "name": "covid 19 pandemic, trust, actor, social science, hybrid (T10), n=24", "lines": 3, "tooltip": ""}]}]}]}]};
const collapsedDepth = 1;

const width = 1800;
const dx = 180;
const dy = 160;
const margin = {top: 20, left: 60};
const wrapWidth = 180;
const lineHeight = 14;

const root = d3.hierarchy(treeData);
root.x0 = 0;
root.y0 = 0;

function collapse(d) {
  if (d.children) {
    d._children = d.children;
    d._children.forEach(collapse);
    d.children = null;
  }
}

root.descendants().forEach(d => {
  if (d.depth >= collapsedDepth) {
    collapse(d);
  }
});

const tree = d3.tree()
  .nodeSize([dx, dy])
  .separation((a, b) => {
    const la = a.data.lines || 1;
    const lb = b.data.lines || 1;
    const base = a.parent === b.parent ? 1 : 1.2;
    return base * Math.max(la, lb);
  });
const diagonal = d3.linkVertical().x(d => d.x).y(d => d.y);

const svg = d3.select("#chart").append("svg")
  .attr("width", width)
  .style("font", "12px sans-serif");

const gMain = svg.append("g");
const gLink = gMain.append("g").attr("class", "links");
const gNode = gMain.append("g").attr("class", "nodes");

function update(source) {
  const sourcePos = {x: (source.x0 ?? source.x), y: (source.y0 ?? source.y)};
  const nodes = root.descendants();
  const links = root.links();

  tree(root);

  let left = root;
  let right = root;
  root.eachBefore(node => {
    if (node.x < left.x) left = node;
    if (node.x > right.x) right = node;
  });

  const widthNeeded = right.x - left.x + dx * 4;
  const heightNeeded = root.height * dy + dy * 2;
  const svgWidth = Math.max(width, widthNeeded) + margin.left + 40;
  const svgHeight = heightNeeded + margin.top + 40;
  svg.attr("width", svgWidth).attr("height", svgHeight);
  gMain.attr("transform", `translate(${margin.left - left.x + dx * 2},${margin.top})`);

  const node = gNode.selectAll("g").data(nodes, d => d.id);

  const nodeEnter = node.enter().append("g")
    .attr("class", "node")
    .attr("transform", d => `translate(${sourcePos.x},${sourcePos.y})`)
    .on("click", (event, d) => {
      if (d.children) {
        d._children = d.children;
        d.children = null;
      } else {
        d.children = d._children;
        d._children = null;
      }
      update(d);
    });

  nodeEnter.append("circle")
    .attr("r", 5);

  const label = nodeEnter.append("text")
    .attr("dy", "0.31em")
    .attr("x", d => d.children || d._children ? -10 : 10)
    .attr("text-anchor", d => d.children || d._children ? "end" : "start")
    .text(d => d.data.name);

  label.call(wrap, wrapWidth);
  label.clone(true).lower().attr("stroke", "white");

  nodeEnter.append("text")
    .attr("class", "toggle")
    .attr("dy", "0.31em")
    .attr("x", -2)
    .attr("text-anchor", "middle")
    .text(d => d._children ? "+" : d.children ? "-" : "");

  nodeEnter.append("title").text(d => d.data.tooltip || d.data.name);

  const nodeUpdate = nodeEnter.merge(node);
  nodeUpdate.transition().duration(250)
    .attr("transform", d => `translate(${d.x},${d.y})`);

  nodeUpdate.select("text.toggle")
    .text(d => d._children ? "+" : d.children ? "-" : "");

  const nodeExit = node.exit().transition().duration(250)
    .attr("transform", d => `translate(${sourcePos.x},${sourcePos.y})`)
    .remove();

  nodeExit.select("circle").attr("r", 0);

  const link = gLink.selectAll("path").data(links, d => d.target.id);

  const linkEnter = link.enter().append("path")
    .attr("class", "link")
    .attr("d", d => {
      const o = {x: sourcePos.x, y: sourcePos.y};
      return diagonal({source: o, target: o});
    });

  linkEnter.merge(link).transition().duration(250)
    .attr("d", diagonal);

  link.exit().transition().duration(250)
    .attr("d", d => {
      const o = {x: sourcePos.x, y: sourcePos.y};
      return diagonal({source: o, target: o});
    })
    .remove();

  root.eachBefore(d => {
    d.x0 = d.x;
    d.y0 = d.y;
  });
}

update(root);

function wrap(text, width) {
  text.each(function() {
    const text = d3.select(this);
    const words = text.text().split(/\s+/).reverse();
    let word;
    let line = [];
    let lineNumber = 0;
    const x = text.attr("x");
    const y = text.attr("y");
    const dyText = parseFloat(text.attr("dy")) || 0;
    let tspan = text.text(null).append("tspan")
      .attr("x", x)
      .attr("y", y)
      .attr("dy", dyText + "em");

    while ((word = words.pop())) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        tspan = text.append("tspan")
          .attr("x", x)
          .attr("y", y)
          .attr("dy", (lineNumber + 1) * (lineHeight / 12) + "em")
          .text(word);
        lineNumber += 1;
      }
    }
  });
}
</script>
</body>
</html>
